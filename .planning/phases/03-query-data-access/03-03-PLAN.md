---
phase: 03-query-data-access
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/cli/db.go
  - internal/cli/root.go
autonomous: true

must_haves:
  truths:
    - "forge db create creates a PostgreSQL database using createdb"
    - "forge db drop destroys a PostgreSQL database using dropdb"
    - "forge db console opens psql connected to the configured database"
    - "forge db seed runs the seed file to populate development data"
    - "forge db reset drops, creates, migrates, and seeds in one command"
  artifacts:
    - path: "internal/cli/db.go"
      provides: "All forge db subcommands"
      contains: "newDBCmd"
    - path: "internal/cli/root.go"
      provides: "db command registered in root"
      contains: "newDBCmd"
  key_links:
    - from: "internal/cli/db.go"
      to: "internal/config/config.go"
      via: "Reads database URL from forge.toml"
      pattern: "config\\.Load"
    - from: "internal/cli/db.go"
      to: "internal/cli/root.go"
      via: "Registered as subcommand"
      pattern: "newDBCmd"
---

<objective>
Implement forge db CLI commands for development database management.

Purpose: CLI-04 requires forge db commands (create, drop, seed, console, reset) for managing the development database. These are essential developer workflow commands that wrap PostgreSQL CLI tools (createdb, dropdb, psql) and integrate with Atlas migrations and user-defined seed files.

Output: Complete forge db command group with 5 subcommands registered in the CLI.
</objective>

<execution_context>
@/Users/nathananderson-tennant/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nathananderson-tennant/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@internal/cli/root.go
@internal/cli/migrate.go
@internal/config/config.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create forge db create, drop, and console commands</name>
  <files>
    internal/cli/db.go
    internal/cli/root.go
  </files>
  <action>
Create the forge db command group with create, drop, and console subcommands.

1. Create `internal/cli/db.go`:

   - `newDBCmd() *cobra.Command`: Parent command with Use="db", Short="Manage development database"
     - Adds subcommands: create, drop, console, seed, reset

   - `newDBCreateCmd() *cobra.Command`:
     - Use: "create", Short: "Create the development database"
     - Finds project root (findProjectRoot -- same helper as migrate.go)
     - Loads forge.toml config
     - Parses database name from config.Database.URL:
       - Parse URL, extract path component (after last "/"), strip query params
       - Example: `postgres://localhost:5432/my-app?sslmode=disable` -> `my-app`
     - Also parse host and port from URL for createdb flags
     - Runs `exec.Command("createdb", "-h", host, "-p", port, dbName)`
     - On success: `ui.Success("Database created: " + dbName)`
     - On "already exists" error: `ui.Info("Database already exists: " + dbName)` (not an error)
     - On other error: return wrapped error

   - `newDBDropCmd() *cobra.Command`:
     - Use: "drop", Short: "Drop the development database"
     - Same URL parsing as create
     - Runs `exec.Command("dropdb", "--if-exists", "-h", host, "-p", port, dbName)`
     - On success: `ui.Success("Database dropped: " + dbName)`

   - `newDBConsoleCmd() *cobra.Command`:
     - Use: "console", Short: "Open a psql session to the database"
     - Loads forge.toml config
     - Runs `exec.Command("psql", config.Database.URL)` with:
       - `cmd.Stdin = os.Stdin`
       - `cmd.Stdout = os.Stdout`
       - `cmd.Stderr = os.Stderr`
     - This hands off terminal control to psql interactively

   - Helper function `parseDatabaseURL(rawURL string) (host, port, dbName string, err error)`:
     - Uses `net/url.Parse`
     - Extracts host (default "localhost"), port (default "5432"), database name from path
     - Handles both `postgres://` and `postgresql://` schemes

2. Update `internal/cli/root.go`:
   - Add `cmd.AddCommand(newDBCmd())` in the root command setup (follow pattern of existing commands)

3. Follow the same patterns as migrate.go:
   - Same findProjectRoot() usage
   - Same config loading pattern
   - Same ui.Header/ui.Success/ui.Error/ui.Info styling
   - Same error message formatting

NOTE: createdb, dropdb, and psql are PostgreSQL client tools that must be installed on the developer's system. If they're not found (exec.ErrNotFound), display a helpful error: "PostgreSQL client tools not found. Install postgresql-client or postgresql to get createdb, dropdb, and psql."
  </action>
  <verify>
Run `go build .` to verify the forge binary compiles with the new db commands. Run `./forge db --help` and verify create, drop, console, seed, reset subcommands are listed.
  </verify>
  <done>
forge db create, drop, and console commands work. Database name parsed from forge.toml URL. Commands use createdb/dropdb/psql. Registered in root CLI.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create forge db seed and reset commands</name>
  <files>
    internal/cli/db.go
  </files>
  <action>
Add seed and reset subcommands to the forge db command group.

1. Add `newDBSeedCmd() *cobra.Command` to db.go:
   - Use: "seed", Short: "Run database seed file"
   - Finds project root, loads config
   - Looks for seed file at `db/seed.go` in the project root
   - If seed file doesn't exist: `ui.Info("No seed file found at db/seed.go. Create one to populate development data.")`
   - If seed file exists: runs `go run db/seed.go` from the project root
     - `cmd := exec.Command("go", "run", "./db/seed.go")`
     - `cmd.Dir = projectRoot`
     - `cmd.Stdout = os.Stdout`
     - `cmd.Stderr = os.Stderr`
     - `cmd.Env = append(os.Environ(), "DATABASE_URL="+cfg.Database.URL)`
   - On success: `ui.Success("Database seeded")`
   - On error: return wrapped error with stderr output

   NOTE: The seed file is a user-written Go file that uses generated factories or raw SQL. Forge doesn't generate it -- it just runs it. The seed file gets DATABASE_URL from env to know which database to connect to.

2. Add `newDBResetCmd() *cobra.Command` to db.go:
   - Use: "reset", Short: "Drop, create, migrate, and seed the database"
   - This is a composite command that runs the full reset sequence:
     1. Drop database (reuse drop logic)
     2. Create database (reuse create logic)
     3. Apply migrations: run `forge migrate up` equivalent
        - Use the same migrate.Up() function from internal/migrate package
        - Need atlas binary check (same as migrate.go pattern)
     4. Seed database: run seed logic (if seed file exists)
   - Display progress for each step:
     - `ui.Header("Resetting database...")`
     - `ui.Info("  Dropping database...")` then `ui.Success("  Database dropped")`
     - `ui.Info("  Creating database...")` then `ui.Success("  Database created")`
     - `ui.Info("  Applying migrations...")` then `ui.Success("  Migrations applied")`
     - `ui.Info("  Running seed...")` then `ui.Success("  Database seeded")` (or skip if no seed)
   - On any error: stop and return the error (don't continue after failed step)

   NOTE: For the migration step, import and call migrate.Up() directly rather than shelling out to forge. This avoids recursive binary invocation. The reset command needs the same atlas binary check and migrate.Config setup as the migrate commands.

3. Extract shared helpers to reduce duplication:
   - `dropDatabase(host, port, dbName string) error` -- shared by drop and reset
   - `createDatabase(host, port, dbName string) error` -- shared by create and reset
   - `runSeed(projectRoot string, cfg *config.Config) error` -- shared by seed and reset

4. Ensure all 5 subcommands are added to the parent db command in newDBCmd().
  </action>
  <verify>
Run `go build .` to verify compilation. Run `./forge db --help` to verify all 5 subcommands listed. Run `./forge db seed --help` and `./forge db reset --help` to verify help text.
  </verify>
  <done>
forge db seed runs db/seed.go with DATABASE_URL env var. forge db reset sequences drop, create, migrate up, and seed. All 5 db subcommands registered and compile cleanly.
  </done>
</task>

</tasks>

<verification>
1. `go build .` -- forge binary compiles with db commands
2. `./forge db --help` -- lists create, drop, console, seed, reset
3. `./forge db create --help` -- shows correct usage
4. `./forge db reset --help` -- shows correct usage
5. `go vet ./internal/cli/` -- no issues
6. Database name parsing extracts correct name from various URL formats
</verification>

<success_criteria>
- forge db create/drop use createdb/dropdb with parsed URL
- forge db console opens interactive psql session
- forge db seed runs db/seed.go with DATABASE_URL
- forge db reset orchestrates full drop/create/migrate/seed sequence
- All commands follow existing CLI patterns (ui styling, project root detection, config loading)
</success_criteria>

<output>
After completion, create `.planning/phases/03-query-data-access/03-03-SUMMARY.md`
</output>
