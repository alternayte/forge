---
phase: 03-query-data-access
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/generator/validation.go
  - internal/generator/validation_test.go
  - internal/generator/templates/validation.go.tmpl
  - internal/generator/queries.go
  - internal/generator/queries_test.go
  - internal/generator/templates/queries.go.tmpl
  - internal/generator/funcmap.go
  - internal/generator/generator.go
autonomous: true

must_haves:
  truths:
    - "forge generate produces validation functions for each resource in gen/validation/"
    - "forge generate produces query builder mod functions for each resource in gen/queries/"
    - "Validation functions check Required fields, MaxLen, MinLen, and enum membership"
    - "Query mods provide type-safe WHERE clauses (EQ, NEQ, Contains, GTE, LTE) for filterable fields"
    - "Query mods provide type-safe ORDER BY for sortable fields"
  artifacts:
    - path: "internal/generator/validation.go"
      provides: "GenerateValidation function"
      exports: ["GenerateValidation"]
    - path: "internal/generator/templates/validation.go.tmpl"
      provides: "Template for per-resource validation functions"
      contains: "ValidateCreate"
    - path: "internal/generator/queries.go"
      provides: "GenerateQueries function"
      exports: ["GenerateQueries"]
    - path: "internal/generator/templates/queries.go.tmpl"
      provides: "Template for per-resource query builder mods"
      contains: "FilterMods"
    - path: "internal/generator/generator.go"
      provides: "Updated orchestrator calling validation + queries generators"
      contains: "GenerateValidation"
  key_links:
    - from: "internal/generator/generator.go"
      to: "internal/generator/validation.go"
      via: "GenerateValidation function call in Generate()"
      pattern: "GenerateValidation"
    - from: "internal/generator/generator.go"
      to: "internal/generator/queries.go"
      via: "GenerateQueries function call in Generate()"
      pattern: "GenerateQueries"
    - from: "internal/generator/templates/queries.go.tmpl"
      to: "internal/generator/funcmap.go"
      via: "Template helpers for field type inspection"
      pattern: "isFilterable|isSortable"
---

<objective>
Generate type-safe validation functions and Bob query builder mod functions from resource IR.

Purpose: GEN-02 (query builder mods) and GEN-03 (validation functions) are the core generated artifacts that the action layer and query system will consume. Validation functions return structured FieldError maps. Query mods produce composable Bob WHERE and ORDER BY clauses for each filterable/sortable field.

Output: GenerateValidation and GenerateQueries functions with templates, tests, and orchestrator wiring.
</objective>

<execution_context>
@/Users/nathananderson-tennant/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nathananderson-tennant/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-query-data-access/03-RESEARCH.md
@internal/generator/generator.go
@internal/generator/funcmap.go
@internal/generator/models.go
@internal/generator/templates/model.go.tmpl
@internal/parser/ir.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create validation function generation</name>
  <files>
    internal/generator/validation.go
    internal/generator/validation_test.go
    internal/generator/templates/validation.go.tmpl
    internal/generator/funcmap.go
  </files>
  <action>
Create a validation generator that produces per-resource validation files in gen/validation/.

1. Create `internal/generator/templates/validation.go.tmpl`:
   - Package declaration: `package validation`
   - DO NOT EDIT header (same pattern as model.go.tmpl)
   - Import the project's gen/models package for input types
   - Define shared types at top (only in first file or separate types file):
     - `FieldError` struct with `Field string`, `Rule string`, `Message string` (json tags)
     - `ValidationErrors` as `map[string][]FieldError`
     - `Add(field, rule, message string)` method on ValidationErrors
     - `HasErrors() bool` method
     - `Error() string` method (implements error interface, joins all messages with "; ")
   - Generate `Validate{Resource}Create(input models.{Resource}Create) ValidationErrors` function:
     - For each field with Required modifier: check zero value (empty string for string types, zero for int, etc.), add FieldError with rule "required"
     - For each field with MaxLen modifier: check `len(input.Field) > maxLen`, add FieldError with rule "max_len"
     - For each field with MinLen modifier: check `len(input.Field) < minLen`, add FieldError with rule "min_len"
     - For Enum fields: check value is in allowed enum values list, add FieldError with rule "enum"
     - For Email fields: basic format check (contains "@" and "."), add FieldError with rule "format"
   - Generate `Validate{Resource}Update(input models.{Resource}Update) ValidationErrors` function:
     - Same checks but only on non-nil pointer fields (since update fields are all pointers)

2. Create `internal/generator/validation.go`:
   - `GenerateValidation(resources []parser.ResourceIR, outputDir, projectModule string) error`
   - First, generate a shared `types.go` file in gen/validation/ with FieldError, ValidationErrors, Add, HasErrors, Error
   - Then for each resource, render validation.go.tmpl to `gen/validation/{snake_name}_validation.go`
   - Use existing `renderTemplate` + `writeGoFile` pipeline

3. Add template helpers to funcmap.go:
   - `zeroValue(fieldType string) string` -- returns Go zero value for comparison: `""` for string types, `0` for int, `false` for bool, `uuid.UUID{}` for UUID, etc.
   - `enumValues(field FieldIR) []string` -- returns field.EnumValues
   - `hasMinLen(modifiers []ModifierIR) bool`
   - `getMinLen(modifiers []ModifierIR) interface{}`
   - `getMaxLen(modifiers []ModifierIR) interface{}`

4. Create `internal/generator/validation_test.go`:
   - Test with a Product resource that has Required, MaxLen, MinLen, and Enum fields
   - Verify generated file exists at correct path
   - Verify generated code contains ValidateProductCreate and ValidateProductUpdate functions
   - Verify Required field generates zero-value check
   - Verify MaxLen generates length check
   - Verify Enum generates membership check
   - Verify generated code compiles with `go/format.Source()`

NOTE: The validation template should generate TWO separate files: a shared types.go (FieldError/ValidationErrors) and per-resource validation files. This prevents type redeclaration when multiple resources exist. Create a separate template `validation_types.go.tmpl` for the shared types.
  </action>
  <verify>
Run `go test ./internal/generator/ -run TestGenerateValidation -v` and `go build ./internal/generator/`
  </verify>
  <done>
GenerateValidation produces gen/validation/types.go (shared types) and gen/validation/{resource}_validation.go files with Validate{Resource}Create and Validate{Resource}Update functions. Tests pass and generated code compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create query builder mod generation and wire orchestrator</name>
  <files>
    internal/generator/queries.go
    internal/generator/queries_test.go
    internal/generator/templates/queries.go.tmpl
    internal/generator/generator.go
  </files>
  <action>
Create a query mod generator that produces per-resource query builder files in gen/queries/, then wire both new generators into the orchestrator.

1. Create `internal/generator/templates/queries.go.tmpl`:
   - Package declaration: `package queries`
   - DO NOT EDIT header
   - Imports: `github.com/stephenafamo/bob/dialect/psql`, `github.com/stephenafamo/bob/dialect/psql/sm`, standard library types as needed
   - For each resource, generate a `{Resource}Filters` struct containing methods that return Bob query mods:
     - For each Filterable field, generate filter methods:
       - `{Field}EQ(val {goType}) bob.Mod[*dialect.SelectQuery]` -- returns `sm.Where(psql.Quote("{snake_field}").EQ(psql.Arg(val)))`
       - `{Field}NEQ(val {goType}) bob.Mod[*dialect.SelectQuery]` -- returns `sm.Where(psql.Quote("{snake_field}").NE(psql.Arg(val)))`
       - `{Field}GTE(val {goType}) bob.Mod[*dialect.SelectQuery]` -- for numeric/date types (Int, BigInt, Decimal, DateTime, Date)
       - `{Field}LTE(val {goType}) bob.Mod[*dialect.SelectQuery]` -- for numeric/date types
       - `{Field}Contains(val string) bob.Mod[*dialect.SelectQuery]` -- for string types (String, Text, Email, URL, Slug), uses ILIKE
     - Generate a `FilterMods(filter models.{Resource}Filter) []bob.Mod[*dialect.SelectQuery]` function that:
       - Checks each filter field for non-nil
       - Appends corresponding mod for each non-nil field
       - Returns slice of mods to apply to query
   - For sorting, generate a `SortMod(sort models.{Resource}Sort) bob.Mod[*dialect.SelectQuery]` function:
     - Validates sort.Field against allowed sortable field names (switch statement)
     - Returns `sm.OrderBy(psql.Quote(columnName))` with `.Asc()` or `.Desc()` based on direction

2. Create `internal/generator/queries.go`:
   - `GenerateQueries(resources []parser.ResourceIR, outputDir, projectModule string) error`
   - For each resource, render queries.go.tmpl to `gen/queries/{snake_name}_queries.go`
   - Use existing `renderTemplate` + `writeGoFile` pipeline

3. Create `internal/generator/queries_test.go`:
   - Test with a Product resource that has Filterable and Sortable fields
   - Verify generated file exists at correct path
   - Verify generated code contains FilterMods function
   - Verify generated code contains SortMod function
   - Verify Filterable fields get EQ/NEQ methods
   - Verify numeric Filterable fields additionally get GTE/LTE methods
   - Verify string Filterable fields additionally get Contains method
   - Verify generated code compiles with `go/format.Source()`

4. Update `internal/generator/generator.go` Generate() function:
   - Add call to `GenerateValidation(resources, cfg.OutputDir, cfg.ProjectModule)` after GenerateFactories
   - Add call to `GenerateQueries(resources, cfg.OutputDir, cfg.ProjectModule)` after GenerateValidation

IMPORTANT: The Bob import paths are `github.com/stephenafamo/bob/dialect/psql` and `github.com/stephenafamo/bob/dialect/psql/sm`. The generated code will compile in the USER's project (which depends on bob), not in the forge framework itself. The forge framework only generates the source code text. So the templates produce Go code that references Bob types, but forge's go.mod does NOT need bob as a dependency. The goimports formatting in writeGoFile handles import organization for the generated output.

IMPORTANT: For the Bob mod return types, use the correct generic type signature. Check Bob v0.42.0 docs -- the mod type may be `bob.Mod[*psql.SelectQuery]` or similar. The template should use the correct type. If the exact generic type is complex, consider using a simpler function signature that returns the mod as a concrete type or using `func(...) sm.QueryMod` if Bob provides that interface.

NOTE: Since this is GENERATED code (text output), the template just needs to produce syntactically valid Go that will compile in a project with Bob as a dependency. Test verification is that the generated text is valid Go (passes go/format.Source), not that it actually executes Bob queries.
  </action>
  <verify>
Run `go test ./internal/generator/ -run TestGenerateQueries -v` and `go build ./internal/generator/` and `go vet ./internal/generator/`
  </verify>
  <done>
GenerateQueries produces gen/queries/{resource}_queries.go files with FilterMods, SortMod, and per-field filter methods. Generate() orchestrator calls both GenerateValidation and GenerateQueries. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `go test ./internal/generator/ -v` -- all existing + new tests pass
2. `go build ./internal/generator/` -- clean compile
3. `go vet ./internal/generator/` -- no issues
4. Generated validation files contain FieldError types, Validate{Resource}Create, Validate{Resource}Update
5. Generated query files contain FilterMods, SortMod, per-field EQ/NEQ/GTE/LTE/Contains methods
6. Generate() orchestrator calls all 5 generators: Models, Atlas, Factories, Validation, Queries
</verification>

<success_criteria>
- gen/validation/ files generated with typed validation for Required, MaxLen, MinLen, Enum, Email format
- gen/queries/ files generated with Bob query mods for filtering and sorting
- All generators wired into Generate() orchestrator
- All tests pass, generated code is valid Go
</success_criteria>

<output>
After completion, create `.planning/phases/03-query-data-access/03-01-SUMMARY.md`
</output>
