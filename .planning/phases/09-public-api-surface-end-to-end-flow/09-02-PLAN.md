---
phase: 09-public-api-surface-end-to-end-flow
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - forge/auth/apikey.go
  - forge/auth/context.go
  - forge/auth/html_middleware.go
  - forge/auth/oauth.go
  - forge/auth/password.go
  - forge/auth/session.go
  - forge/auth/tenant.go
  - forge/auth/token.go
  - forge/sse/limiter.go
  - forge/notify/hub.go
  - forge/notify/subscription.go
  - forge/jobs/client.go
  - forge/forgetest/app.go
  - forge/forgetest/datastar.go
  - forge/forgetest/db.go
  - internal/api/server.go
  - internal/api/html_server.go
  - internal/generator/templates/actions.go.tmpl
  - internal/generator/templates/queries.go.tmpl
  - internal/generator/templates/scaffold_jobs.go.tmpl
autonomous: true
requirements: []

must_haves:
  truths:
    - "forge/auth/ package exists at repo root and internal/auth/ is deleted"
    - "forge/sse/ package exists and internal/sse/ is deleted"
    - "forge/notify/ package exists and internal/notify/ is deleted"
    - "forge/jobs/ package exists with its own Config struct (not internal/config.JobsConfig)"
    - "forge/forgetest/ package exists with corrected runtime.Caller depth and internal/forgetest/ is deleted"
    - "Generator templates emit github.com/alternayte/forge/forge/auth (not internal/auth)"
    - "go build ./... compiles successfully"
  artifacts:
    - path: "forge/auth/password.go"
      provides: "Public auth package"
      contains: "package auth"
    - path: "forge/sse/limiter.go"
      provides: "Public SSE package"
      contains: "package sse"
    - path: "forge/notify/hub.go"
      provides: "Public notify package"
      contains: "package notify"
    - path: "forge/jobs/client.go"
      provides: "Public jobs package with own Config"
      contains: "type Config struct"
    - path: "forge/forgetest/db.go"
      provides: "Public forgetest package"
      contains: "package forgetest"
  key_links:
    - from: "internal/api/server.go"
      to: "forge/auth/"
      via: "import github.com/alternayte/forge/forge/auth"
      pattern: "alternayte/forge/forge/auth"
    - from: "internal/generator/templates/actions.go.tmpl"
      to: "forge/auth/"
      via: "forgeauth import path in template"
      pattern: "alternayte/forge/forge/auth"
    - from: "forge/jobs/client.go"
      to: "forge/jobs/Config"
      via: "own Config struct (not internal/config.JobsConfig)"
      pattern: "type Config struct"
---

<objective>
Move five internal packages to public forge/ sub-packages: auth, sse, notify, jobs, forgetest. Move implementations directly (not thin re-exports).

Purpose: Makes the runtime API surface public so generated apps can import forge/auth, forge/sse, forge/notify, forge/jobs, and forge/forgetest directly. This is a locked decision — implementations move directly, no wrapper indirection.

Output: Five new public packages under forge/, all internal counterparts deleted, all callers updated, generator templates updated to emit new import paths.
</objective>

<execution_context>
@/Users/nathananderson-tennant/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nathananderson-tennant/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-public-api-surface-end-to-end-flow/09-RESEARCH.md
@.planning/phases/09-public-api-surface-end-to-end-flow/09-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move auth, sse, and notify packages to forge/</name>
  <files>
    forge/auth/*.go
    forge/sse/limiter.go
    forge/notify/hub.go
    forge/notify/subscription.go
    internal/api/server.go
    internal/api/html_server.go
  </files>
  <action>
Move three packages from internal/ to forge/:

1. **Create forge/ directory** at repo root if it doesn't exist: `mkdir -p forge/auth forge/sse forge/notify`

2. **Move auth package** — `git mv internal/auth/* forge/auth/`. The package name stays `auth`. All 8 files move:
   - apikey.go, context.go, html_middleware.go, oauth.go, password.go, session.go, tenant.go, token.go
   - After move, the import path changes from `github.com/alternayte/forge/internal/auth` to `github.com/alternayte/forge/forge/auth`

3. **Move sse package** — `git mv internal/sse/* forge/sse/`. Package name stays `sse`.
   - limiter.go moves

4. **Move notify package** — `git mv internal/notify/* forge/notify/`. Package name stays `notify`.
   - hub.go, subscription.go move

5. **Global find-replace for all three import paths** across all .go and .tmpl files:
   - `github.com/alternayte/forge/internal/auth` -> `github.com/alternayte/forge/forge/auth`
   - `github.com/alternayte/forge/internal/sse` -> `github.com/alternayte/forge/forge/sse`
   - `github.com/alternayte/forge/internal/notify` -> `github.com/alternayte/forge/forge/notify`

6. **Fix internal/api/server.go** — update import from internal/auth to forge/auth. Also update internal/api/html_server.go.

7. **Fix generator templates** — the three templates that hardcode the auth import path:
   - `internal/generator/templates/actions.go.tmpl`: change `forgeauth "github.com/alternayte/forge/internal/auth"` to `forgeauth "github.com/alternayte/forge/forge/auth"`
   - `internal/generator/templates/queries.go.tmpl`: same change
   - `internal/generator/templates/scaffold_jobs.go.tmpl`: same change

8. **Delete empty internal directories** — `rmdir internal/auth internal/sse internal/notify` (should be empty after git mv).

9. **Run `go build ./...`** to verify compilation.
  </action>
  <verify>
    - `ls forge/auth/password.go forge/sse/limiter.go forge/notify/hub.go` all exist
    - `ls internal/auth/ internal/sse/ internal/notify/ 2>/dev/null` returns nothing
    - `grep -r "internal/auth\|internal/sse\|internal/notify" --include="*.go" --include="*.tmpl" .` returns empty
    - `go build ./...` compiles
  </verify>
  <done>auth, sse, and notify packages live under forge/ with correct import paths everywhere. Generator templates emit forge/auth paths.</done>
</task>

<task type="auto">
  <name>Task 2: Move jobs and forgetest packages to forge/</name>
  <files>
    forge/jobs/client.go
    forge/forgetest/app.go
    forge/forgetest/datastar.go
    forge/forgetest/db.go
  </files>
  <action>
Move the remaining two packages:

1. **Move jobs package** — `git mv internal/jobs/* forge/jobs/`.

2. **Fix jobs/client.go Config dependency** — `forge/jobs/client.go` currently imports `internal/config.JobsConfig`. Since `forge/jobs` is public, it cannot expose internal types in its API. Create a `Config` struct directly in `forge/jobs/client.go`:
   ```go
   // Config holds background job processing settings.
   type Config struct {
       Enabled bool
       Queues  map[string]int // queue_name -> max_workers
   }
   ```
   Update `NewRiverClient` to accept `jobs.Config` instead of `config.JobsConfig`. Remove the `internal/config` import.

3. **Move forgetest package** — `git mv internal/forgetest/* forge/forgetest/`.

4. **Fix forgetest/db.go runtime.Caller depth** — The `DefaultTestDBConfig()` function uses `runtime.Caller(0)` to find the repo root. Currently: `filepath.Join(filepath.Dir(filename), "../..")` (two levels up from `internal/forgetest/db.go`). After move to `forge/forgetest/db.go`, the path is THREE levels up from repo root. Update to:
   ```go
   repoRoot := filepath.Join(filepath.Dir(filename), "../../..")
   ```
   Also update the comment: `// filename is forge/forgetest/db.go; repo root is three levels up`

5. **Global find-replace** across all .go and .tmpl files:
   - `github.com/alternayte/forge/internal/jobs` -> `github.com/alternayte/forge/forge/jobs`
   - `github.com/alternayte/forge/internal/forgetest` -> `github.com/alternayte/forge/forge/forgetest`

6. **Update any callers of jobs.NewRiverClient** — check internal/cli/ or internal/watcher/ for callers that pass `config.JobsConfig`. They now need to construct a `jobs.Config{Enabled: cfg.Jobs.Enabled, Queues: cfg.Jobs.Queues}` from the internal config.

7. **Delete empty internal directories** — `rmdir internal/jobs internal/forgetest`.

8. **Run `go build ./...`** to verify compilation.
  </action>
  <verify>
    - `ls forge/jobs/client.go forge/forgetest/db.go` both exist
    - `ls internal/jobs/ internal/forgetest/ 2>/dev/null` returns nothing
    - `grep -r "internal/jobs\|internal/forgetest" --include="*.go" --include="*.tmpl" .` returns empty
    - `grep "type Config struct" forge/jobs/client.go` finds the new Config type
    - `grep "../../.." forge/forgetest/db.go` confirms corrected path depth
    - `go build ./...` compiles
  </verify>
  <done>All five packages (auth, sse, notify, jobs, forgetest) are public under forge/. jobs has its own Config. forgetest has correct runtime.Caller depth. No internal/ references remain.</done>
</task>

</tasks>

<verification>
1. `ls forge/auth/ forge/sse/ forge/notify/ forge/jobs/ forge/forgetest/` — all exist with files
2. `ls internal/auth/ internal/sse/ internal/notify/ internal/jobs/ internal/forgetest/ 2>/dev/null` — all gone
3. `grep -r "internal/auth\|internal/sse\|internal/notify\|internal/jobs\|internal/forgetest" --include="*.go" --include="*.tmpl" .` — empty
4. `go build ./...` — passes
5. `go vet ./...` — passes
</verification>

<success_criteria>
- Five packages live under forge/ as public API surface
- forge/jobs has its own Config struct (no internal/config dependency in public API)
- forge/forgetest has correct runtime.Caller depth for repo root resolution
- Generator templates emit forge/auth import paths
- All code compiles and passes vet
</success_criteria>

<output>
After completion, create `.planning/phases/09-public-api-surface-end-to-end-flow/09-02-SUMMARY.md`
</output>
