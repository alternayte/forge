---
phase: 05-rest-api-generation
plan: 03
subsystem: api
tags: [huma, chi, scalarui, cors, rate-limiting, auth, openapi, code-generation, middleware]

# Dependency graph
requires:
  - phase: 05-rest-api-generation/05-01
    provides: GenerateAPI function, per-resource Huma Input/Output templates, api_types.go.tmpl
  - phase: 05-rest-api-generation/05-02
    provides: AuthMiddleware, CORSMiddleware, RateLimitMiddleware, APIConfig struct
  - phase: 04-action-layer-error-handling
    provides: actions.Registry type used in RegisterAllRoutes dispatcher

provides:
  - "SetupAPI function wiring Huma+Chi with 6-layer middleware chain (RealIP->Logger->Recovery->CORS->RateLimit->Auth)"
  - "RegisterDocsHandler serving embedded Scalar UI at /api/docs with CDN-free nyxstack/scalarui"
  - "wrapHTTPMiddleware bridging http.Handler middleware to huma.Context middleware via humachi.Unwrap"
  - "api_register_all.go.tmpl generating RegisterAllRoutes dispatcher over all resource-specific route functions"
  - "GenerateAPI wired as 12th generator in forge generate orchestrator pipeline"

affects:
  - 06-html-generation
  - 07-public-access-annotations
  - any future plan that wires the HTTP server in main.go

# Tech tracking
tech-stack:
  added:
    - "github.com/go-chi/chi/v5 v5.2.5 — Chi router (direct dep; humachi adapter requires it)"
    - "github.com/nyxstack/scalarui v1.0.0 — Scalar UI embedded docs (CDN-free, single-binary)"
  patterns:
    - "wrapHTTPMiddleware adapter pattern: use humachi.Unwrap to bridge http.Handler and huma.Context middleware"
    - "Docs handler: scalarui.NewConfig().With*() builder chain -> scalarui.New(cfg).Render() -> chi.Get route"
    - "SetupAPI accepts func(huma.API) for route registration — caller wraps genapi.RegisterAllRoutes with registry closure"
    - "RegisterAllRoutes template: type-asserts registry.Get(name) to per-resource Actions interface before registering routes"

key-files:
  created:
    - internal/api/server.go
    - internal/api/docs.go
    - internal/generator/templates/api_register_all.go.tmpl
  modified:
    - internal/generator/api.go (added register_all.go generation step)
    - internal/generator/generator.go (added GenerateAPI as 12th generator)
    - go.mod, go.sum (added go-chi/chi v5 and nyxstack/scalarui as direct deps)

key-decisions:
  - "SetupAPI accepts func(huma.API) for route registration (not func(huma.API, *actions.Registry)) — gen/actions is user-generated code, forge tool cannot import it; caller uses a closure to bind the registry"
  - "wrapHTTPMiddleware uses humachi.Unwrap to extract *http.Request and http.ResponseWriter for bridging http.Handler middlewares into Huma middleware chain"
  - "api_register_all.go.tmpl uses registry.Get(name) with type assertion to {Name}Actions — avoids strong coupling while preserving type safety at registration time"
  - "Scalar UI uses WithTheme(purple), WithDarkMode(true), WithInteractive(true) — embedded CDN-free, consistent with single-binary deployment"

patterns-established:
  - "Huma middleware from http.Handler: use wrapHTTPMiddleware(corsHandler) / wrapHTTPMiddleware(rateLimitHandler) pattern"
  - "RegisterAllRoutes dispatcher: generated once (not per-resource), calls all Register{Name}Routes functions"
  - "GenerateAPI is always last in the generator orchestrator — depends on all other generated types"

# Metrics
duration: 5min
completed: 2026-02-17
---

# Phase 5 Plan 03: API Server Assembly Summary

**Huma+Chi server with 6-layer middleware chain, CDN-free Scalar UI docs at /api/docs, and RegisterAllRoutes dispatcher generated by forge generate**

## Performance

- **Duration:** 5 min
- **Started:** 2026-02-17T19:07:51Z
- **Completed:** 2026-02-17T19:13:17Z
- **Tasks:** 2
- **Files modified:** 6 (2 created, 2 new, 2 modified)

## Accomplishments

- `SetupAPI` wires Chi (RealIP->Logger->Recovery) and Huma (CORS->RateLimit->Auth) middleware in correct security order, then calls `registerRoutes(api)` to register all generated CRUD endpoints
- `wrapHTTPMiddleware` bridges standard `http.Handler` middleware to Huma's context-based middleware via `humachi.Unwrap` — enables CORS and rate limit wrappers to work in the Huma middleware chain
- `RegisterDocsHandler` serves Scalar UI (embedded, CDN-free) at `/api/docs` using `nyxstack/scalarui`; Huma's built-in Stoplight Elements CDN docs disabled via `DocsPath = ""`
- Huma config sets `OpenAPIPath = "/api/openapi"` so `/api/openapi.json` and `/api/openapi.yaml` are served natively
- `api_register_all.go.tmpl` generates `RegisterAllRoutes(api huma.API, registry *actions.Registry)` — a dispatcher that type-asserts each resource's actions from the registry and calls `Register{Name}Routes`
- `GenerateAPI` added as 12th generator in `generator.go` after `GenerateMiddleware`, completing the 12-generator pipeline

## Task Commits

Each task was committed atomically:

1. **Task 1: Create API server setup with Huma, middleware wiring, and Scalar UI docs** - `0280ce9` (feat)
2. **Task 2: Wire GenerateAPI as 12th generator and add RegisterAllRoutes template** - `aac7f48` (feat)

## Files Created/Modified

- `internal/api/server.go` - SetupAPI function with 6-layer middleware chain, wrapHTTPMiddleware adapter, ServerConfig struct
- `internal/api/docs.go` - RegisterDocsHandler serving Scalar UI at /api/docs via nyxstack/scalarui
- `internal/generator/templates/api_register_all.go.tmpl` - Generates RegisterAllRoutes dispatcher over all resource-specific Register{Name}Routes functions
- `internal/generator/api.go` - Added register_all.go generation as final step in GenerateAPI
- `internal/generator/generator.go` - Added GenerateAPI as 12th and final generator after GenerateMiddleware
- `go.mod`, `go.sum` - Added go-chi/chi v5.2.5 and nyxstack/scalarui v1.0.0 as direct dependencies

## Decisions Made

- **SetupAPI accepts `func(huma.API)` for route registration:** The `gen/actions` package is user-generated code that the forge tool binary cannot import. Accepting a plain `func(huma.API)` lets callers pass a closure: `func(api huma.API) { genapi.RegisterAllRoutes(api, registry) }`. The doc comment explicitly shows `genapi.RegisterAllRoutes` as the intended argument.
- **wrapHTTPMiddleware via humachi.Unwrap:** CORS and rate limit middleware are `http.Handler`-based wrappers. Huma middleware is `func(huma.Context, func(huma.Context))`. The bridge uses `humachi.Unwrap(ctx)` to get the underlying `(*http.Request, http.ResponseWriter)` and then calls the `http.Handler` wrapper around a `next(ctx)` call.
- **RegisterAllRoutes template uses type assertion:** `registry.Get(name)` returns `any`; the template type-asserts to `actions.{Name}Actions`. This avoids coupling the generated dispatcher to specific concrete types while maintaining type safety at registration time.
- **Scalar UI theme/config:** purple theme, dark mode, sidebar, interactive — chosen for developer UX consistency. CDN-free via embedded `nyxstack/scalarui` package aligns with single-binary deployment philosophy.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Installed go-chi/chi/v5 as direct dependency**
- **Found during:** Task 1 (creating server.go)
- **Issue:** `go-chi/chi/v5` was not in go.mod (only available as indirect dep via huma adapter); import from server.go required direct dependency
- **Fix:** Ran `go get github.com/go-chi/chi/v5` then `go mod tidy` to promote to direct dependency
- **Files modified:** go.mod, go.sum
- **Verification:** `go build ./internal/api/` passes; go.mod shows `github.com/go-chi/chi/v5 v5.2.5` (no `// indirect`)
- **Committed in:** 0280ce9 (Task 1 commit)

**2. [Rule 2 - Missing Critical] Added api_register_all.go.tmpl for RegisterAllRoutes**
- **Found during:** Task 2 (wiring GenerateAPI into orchestrator)
- **Issue:** Plan required server.go to call `RegisterAllRoutes` but per-resource templates only generated `Register{Name}Routes` — no dispatcher function existed. Without RegisterAllRoutes the middleware and route registration intent could not be fulfilled.
- **Fix:** Created `api_register_all.go.tmpl` generating a `RegisterAllRoutes(api, registry)` dispatcher, updated `api.go` to call this template, tests continue to pass
- **Files modified:** internal/generator/templates/api_register_all.go.tmpl, internal/generator/api.go
- **Verification:** `go test ./internal/generator/ -v` — all tests pass including TestGenerateAPI_MultipleResources which verifies multi-resource generation
- **Committed in:** aac7f48 (Task 2 commit)

---

**Total deviations:** 2 auto-fixed (1 blocking, 1 missing critical)
**Impact on plan:** Both fixes necessary for plan correctness — chi dependency required for compilation, RegisterAllRoutes required for the complete route registration architecture.

## Issues Encountered

None beyond the auto-fixed deviations above. Template renders correctly with proper funcmap support (`lower` helper available).

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- `SetupAPI` ready for use in a generated project's `main.go` with `genapi.RegisterAllRoutes` closure
- `RegisterDocsHandler` ready to add Scalar UI docs to any Chi router
- `forge generate` now produces `gen/api/` with inputs, outputs, routes, types, and register_all files
- OpenAPI spec path and Scalar UI path are configured and ready for integration testing
- Phase 6 (HTML generation) can use the same Chi router pattern and action registry

---
*Phase: 05-rest-api-generation*
*Completed: 2026-02-17*

## Self-Check: PASSED

All files verified present:
- FOUND: internal/api/server.go
- FOUND: internal/api/docs.go
- FOUND: internal/generator/templates/api_register_all.go.tmpl
- FOUND: internal/generator/api.go
- FOUND: internal/generator/generator.go

All commits verified:
- FOUND: 0280ce9 (Task 1 commit)
- FOUND: aac7f48 (Task 2 commit)
