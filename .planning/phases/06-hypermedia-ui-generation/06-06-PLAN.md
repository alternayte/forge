---
phase: 06-hypermedia-ui-generation
plan: 06
type: execute
wave: 3
depends_on: ["06-03", "06-04"]
files_modified:
  - internal/generator/scaffold.go
  - internal/generator/scaffold_test.go
autonomous: true

must_haves:
  truths:
    - "ScaffoldResource writes form.templ, list.templ, detail.templ, handlers.go, hooks.go into resources/<name>/views/"
    - "ScaffoldResource skips existing files (does not overwrite developer changes)"
    - "DiffResource renders scaffold to buffer and produces unified diff against on-disk files"
    - "Scaffolded files use correct project module import paths"
  artifacts:
    - path: "internal/generator/scaffold.go"
      provides: "ScaffoldResource and DiffResource functions"
      exports: ["ScaffoldResource", "DiffResource"]
    - path: "internal/generator/scaffold_test.go"
      provides: "Tests for scaffold generation"
      contains: "TestScaffoldResource"
  key_links:
    - from: "internal/generator/scaffold.go"
      to: "internal/generator/templates/scaffold_form.templ.tmpl"
      via: "renderTemplate"
      pattern: "renderTemplate.*scaffold_form"
    - from: "internal/generator/scaffold.go"
      to: "internal/generator/templates/scaffold_handlers.go.tmpl"
      via: "renderTemplate"
      pattern: "renderTemplate.*scaffold_handlers"
---

<objective>
Create scaffold generator with file existence checking and diff capability

Purpose: Implement the ScaffoldResource and DiffResource functions that power `forge generate resource <name>` and `forge generate resource <name> --diff`. ScaffoldResource writes scaffold-once files (form.templ, list.templ, detail.templ, handlers.go, hooks.go) into resources/<name>/ and refuses to overwrite existing files. DiffResource produces a unified diff between current and freshly-rendered scaffold files.

Output: scaffold.go with ScaffoldResource/DiffResource, comprehensive tests
</objective>

<execution_context>
@/Users/nathananderson-tennant/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nathananderson-tennant/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@internal/generator/generator.go
@internal/generator/funcmap.go
@.planning/phases/06-hypermedia-ui-generation/06-RESEARCH.md
@.planning/phases/06-hypermedia-ui-generation/06-03-SUMMARY.md
@.planning/phases/06-hypermedia-ui-generation/06-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ScaffoldResource function with skip-if-exists logic</name>
  <files>
    internal/generator/scaffold.go
  </files>
  <action>
    Install diff dependency:
    ```
    go get github.com/sergi/go-diff/diffmatchpatch
    ```

    Create scaffold.go in internal/generator/ with:

    1. ScaffoldResult struct:
       - Created []string (files written)
       - Skipped []string (files that already existed)

    2. scaffoldFile struct (internal):
       - Template string (template name in TemplatesFS)
       - OutputPath string (relative to resource dir, e.g., "views/form.templ")
       - IsTempl bool (true for .templ files, false for .go files)

    3. scaffoldFiles() returns the list of scaffold files:
       - {Template: "scaffold_form.templ.tmpl", OutputPath: "views/form.templ", IsTempl: true}
       - {Template: "scaffold_list.templ.tmpl", OutputPath: "views/list.templ", IsTempl: true}
       - {Template: "scaffold_detail.templ.tmpl", OutputPath: "views/detail.templ", IsTempl: true}
       - {Template: "scaffold_handlers.go.tmpl", OutputPath: "handlers.go", IsTempl: false}
       - {Template: "scaffold_hooks.go.tmpl", OutputPath: "hooks.go", IsTempl: false}

    4. ScaffoldResource(resource parser.ResourceIR, projectRoot, projectModule string) (*ScaffoldResult, error):
       - resourceDir = filepath.Join(projectRoot, "resources", snake(resource.Name))
       - For each scaffoldFile:
         - Compute full path: filepath.Join(resourceDir, sf.OutputPath)
         - Check if file exists (os.Stat). If it exists, add to result.Skipped and continue.
         - Render template with {Resource: resource, ProjectModule: projectModule}
         - If IsTempl: use writeRawFile (templ files are not Go files)
         - If not IsTempl: use writeGoFile (Go files get formatting + imports)
         - Add to result.Created
       - Return result

    5. renderScaffoldToMap(resource parser.ResourceIR, projectModule string) (map[string][]byte, error):
       - Renders all scaffold templates into a map of outputPath -> rendered bytes
       - Used by both ScaffoldResource and DiffResource

    6. DiffResource(resource parser.ResourceIR, projectRoot, projectModule string) (string, error):
       - Renders all scaffolds via renderScaffoldToMap
       - For each scaffold file, reads the on-disk version
       - If file doesn't exist: reports "File does not exist (would be created)"
       - If file exists: uses diffmatchpatch.New() to produce unified diff
       - Calls dmp.DiffCleanupSemantic for readability
       - Returns concatenated diff output for all files, prefixed with file paths

    Run go mod tidy after.
  </action>
  <verify>
    go build ./internal/generator/
    go vet ./internal/generator/
  </verify>
  <done>
    ScaffoldResource writes 5 scaffold files (3 templ views + 2 Go files) into resources/<name>/ with skip-if-exists protection. DiffResource produces unified diff between on-disk and freshly-rendered scaffolds. renderScaffoldToMap shared between both functions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create comprehensive scaffold tests</name>
  <files>
    internal/generator/scaffold_test.go
  </files>
  <action>
    Create scaffold_test.go with:

    1. TestScaffoldResource:
       - Creates temp directory as project root
       - Calls ScaffoldResource with sample resource (Product with Name/Price fields)
       - Verifies result.Created contains all 5 files
       - Verifies result.Skipped is empty
       - Reads each generated file and checks for key content:
         - form.templ: contains "ProductForm", "data-bind", "errors"
         - list.templ: contains "ProductList", "table"
         - detail.templ: contains "ProductDetail"
         - handlers.go: contains "HandleCreate", "acts.Create", "datastar"
         - hooks.go: contains "BeforeCreate", "AfterCreate"

    2. TestScaffoldResource_SkipsExisting:
       - Creates temp directory
       - Pre-creates resources/product/views/form.templ with custom content
       - Calls ScaffoldResource
       - Verifies form.templ is in result.Skipped
       - Verifies other 4 files are in result.Created
       - Verifies form.templ content was NOT overwritten (still has custom content)

    3. TestScaffoldResource_MultipleResources:
       - Scaffolds Product and Category
       - Verifies separate directories: resources/product/ and resources/category/
       - Verifies no cross-contamination (product files don't reference Category)

    4. TestDiffResource:
       - Creates temp directory
       - Scaffolds a resource first
       - Modifies one file (e.g., changes a label in form.templ)
       - Calls DiffResource
       - Verifies diff output is non-empty and contains the changed text

    5. TestDiffResource_NoExistingFiles:
       - Calls DiffResource on a resource that hasn't been scaffolded
       - Verifies output mentions files that would be created
  </action>
  <verify>
    go test ./internal/generator/ -run TestScaffold -v
    go test ./internal/generator/ -run TestDiff -v
  </verify>
  <done>
    5 test cases cover: fresh scaffold, skip-existing, multiple resources, diff with changes, diff without existing files. All verify correct file content and skip behavior.
  </done>
</task>

</tasks>

<verification>
- go test ./internal/generator/ -run TestScaffold -v passes all 3 scaffold tests
- go test ./internal/generator/ -run TestDiff -v passes both diff tests
- go build ./internal/generator/ compiles cleanly
- ScaffoldResource skips files that already exist (key safety check)
- ScaffoldResource writes templ files with writeRawFile and Go files with writeGoFile
- DiffResource produces readable unified diff output
- All existing generator tests still pass (no regressions)
</verification>

<success_criteria>
- GEN-09 implementation ready: ScaffoldResource writes form, list, detail templ components
- GEN-10 implementation ready: ScaffoldResource writes handlers and hooks
- GEN-12 implementation ready: DiffResource produces diff between current and fresh scaffold
- Skip-if-exists prevents overwriting developer customizations (Pitfall 2 from research)
</success_criteria>

<output>
After completion, create `.planning/phases/06-hypermedia-ui-generation/06-06-SUMMARY.md`
</output>
