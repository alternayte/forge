# Code generated by forge generate. DO NOT EDIT.

schema "public" {
  comment = "Generated by Forge"
}

{{range .Resources}}
{{$resourceName := .Name}}
table "{{plural (snake .Name)}}" {
  schema = schema.public

  column "id" {
    type    = uuid
    default = sql("gen_random_uuid()")
    null    = false
  }

  {{range .Fields}}
  column "{{snake .Name}}" {
    type = {{atlasTypeWithModifiers .}}
    null = {{atlasNull .Modifiers}}
    {{if hasDefault .}}default = {{atlasDefault .}}{{end}}
  }
  {{end}}

  {{if .HasTimestamps}}
  column "created_at" {
    type    = timestamptz
    default = sql("now()")
    null    = false
  }
  column "updated_at" {
    type    = timestamptz
    default = sql("now()")
    null    = false
  }
  {{end}}

  {{if .Options.SoftDelete}}
  column "deleted_at" {
    type = timestamptz
    null = true
  }
  {{end}}

  {{if .Options.TenantScoped}}
  column "tenant_id" {
    type = uuid
    null = false
  }
  {{end}}

  {{if .Options.Auditable}}
  column "created_by" {
    type = uuid
    null = true
  }
  column "updated_by" {
    type = uuid
    null = true
  }
  {{end}}

  primary_key {
    columns = [column.id]
  }

  {{range .Fields}}
  {{if hasModifier .Modifiers "Unique"}}
  {{if $.Options.SoftDelete}}
  index "{{plural (snake $resourceName)}}_{{snake .Name}}_unique_active" {
    columns = [column.{{snake .Name}}]
    unique  = true
    where   = "deleted_at IS NULL"
  }
  {{else}}
  index "{{plural (snake $resourceName)}}_{{snake .Name}}_unique" {
    columns = [column.{{snake .Name}}]
    unique  = true
  }
  {{end}}
  {{end}}
  {{if hasModifier .Modifiers "Index"}}
  index "{{plural (snake $resourceName)}}_{{snake .Name}}_idx" {
    columns = [column.{{snake .Name}}]
  }
  {{end}}
  {{end}}

  {{if .Options.TenantScoped}}
  index "{{plural (snake $resourceName)}}_tenant_id_idx" {
    columns = [column.tenant_id]
  }

  row_level_security {
    enabled  = true
    enforced = true
  }

  # Tenant isolation RLS policy (defense-in-depth safety net).
  # Application-level WHERE clause via TenantMod handles performance (index usage).
  # RLS blocks access when SET LOCAL app.current_tenant is not set (secure by default).
  policy "tenant_isolation" {
    for    = SELECT
    to     = [PUBLIC]
    using  = "(tenant_id = current_setting('app.current_tenant')::uuid)"
  }
  policy "tenant_isolation_mod" {
    for        = ALL
    to         = [PUBLIC]
    using      = "(tenant_id = current_setting('app.current_tenant')::uuid)"
    with_check = "(tenant_id = current_setting('app.current_tenant')::uuid)"
  }
  {{end}}
}
{{end}}

# Sessions table required by alexedwards/scs pgxstore for PostgreSQL session storage.
# This table is always generated — session management is a core framework feature
# and does not depend on any user-defined resource.
table "sessions" {
  schema = schema.public
  column "token" {
    type = text
    null = false
  }
  column "data" {
    type = sql("bytea")
    null = false
  }
  column "expiry" {
    type = timestamptz
    null = false
  }
  primary_key {
    columns = [column.token]
  }
  index "sessions_expiry_idx" {
    columns = [column.expiry]
  }
}

{{if hasAuditableResource .Resources}}
# Audit log table for tracking all changes to Auditable resources.
# Single shared table — resource_type and resource_id identify the target.
# Per design: full before/after JSONB diff for every changed field.
table "audit_logs" {
  schema = schema.public

  column "id" {
    type    = uuid
    default = sql("gen_random_uuid()")
    null    = false
  }
  column "resource_type" {
    type = varchar(255)
    null = false
  }
  column "resource_id" {
    type = uuid
    null = false
  }
  column "operation" {
    type = varchar(50)
    null = false
  }
  column "changed_fields" {
    type = jsonb
    null = true
  }
  column "created_by" {
    type = uuid
    null = true
  }
  column "created_at" {
    type    = timestamptz
    default = sql("now()")
    null    = false
  }

  primary_key {
    columns = [column.id]
  }

  index "audit_logs_resource_idx" {
    columns = [column.resource_type, column.resource_id]
  }
  index "audit_logs_created_at_idx" {
    columns = [column.created_at]
  }
}
{{end}}
