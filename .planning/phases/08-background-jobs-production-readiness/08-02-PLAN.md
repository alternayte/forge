---
phase: 08-background-jobs-production-readiness
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/config/config.go
  - internal/observe/slog.go
  - internal/observe/otel.go
  - internal/observe/admin.go
autonomous: true
requirements:
  - DEPLOY-01
  - OTEL-01
  - OTEL-02
  - OTEL-03

must_haves:
  truths:
    - "Config loads from forge.toml then env vars override every field (FORGE_DATABASE_URL wins over toml database.url)"
    - "slog uses JSONHandler when FORGE_ENV=production or log_format=json; TextHandler otherwise"
    - "Admin server on separate port serves /metrics (Prometheus), /healthz (JSON with version), and /debug/pprof/"
    - "OTel TracerProvider wraps HTTP handler and pgx pool tracer for automatic span creation"
    - "Prometheus metrics are exposed via OTel-Prometheus bridge on the admin /metrics endpoint"
  artifacts:
    - path: "internal/config/config.go"
      provides: "JobsConfig, SSEConfig, ObserveConfig, AdminConfig structs and ApplyEnvOverrides method"
      contains: "ApplyEnvOverrides"
    - path: "internal/observe/slog.go"
      provides: "NewHandler factory for environment-aware slog handler"
      contains: "func NewHandler"
    - path: "internal/observe/otel.go"
      provides: "OTel SDK bootstrap with TracerProvider, MeterProvider, and shutdown function"
      contains: "func Setup"
    - path: "internal/observe/admin.go"
      provides: "Admin HTTP server with /metrics, /healthz, /debug/pprof endpoints"
      contains: "func StartAdminServer"
  key_links:
    - from: "internal/config/config.go"
      to: "internal/observe/otel.go"
      via: "ObserveConfig passed to observe.Setup for exporter selection"
      pattern: "ObserveConfig"
    - from: "internal/observe/otel.go"
      to: "internal/observe/admin.go"
      via: "Prometheus exporter registered on admin /metrics endpoint"
      pattern: "promhttp"
---

<objective>
Add 12-factor config env override, structured logging, OpenTelemetry instrumentation, Prometheus metrics, and a separate admin HTTP server for operational endpoints.

Purpose: Provides the observability and configuration foundation that all production features depend on — logging, tracing, metrics, and env-based config override.
Output: Extended config with env overrides, slog handler factory, OTel bootstrap, admin server on port 9090.
</objective>

<execution_context>
@/Users/nathananderson-tennant/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nathananderson-tennant/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-background-jobs-production-readiness/08-RESEARCH.md

# Key files
@internal/config/config.go
@internal/cli/version.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend config with new sections and env var override</name>
  <files>
    internal/config/config.go
  </files>
  <action>
1. Add four new config structs to `internal/config/config.go`:

```go
type JobsConfig struct {
    Enabled bool           `toml:"enabled"`
    Queues  map[string]int `toml:"queues"` // queue_name -> max_workers
}

type SSEConfig struct {
    MaxTotalConnections int `toml:"max_total_connections"` // default: 5000
    MaxPerUser          int `toml:"max_per_user"`          // default: 10
    BufferSize          int `toml:"buffer_size"`           // default: 32
}

type ObserveConfig struct {
    OTLPEndpoint string `toml:"otlp_endpoint"` // empty = stdout in dev
    LogLevel     string `toml:"log_level"`     // debug, info, warn, error
    LogFormat    string `toml:"log_format"`    // json or text
}

type AdminConfig struct {
    Port int `toml:"port"` // default: 9090
}
```

2. Add these as fields on the `Config` struct:
```go
Jobs    JobsConfig    `toml:"jobs"`
SSE     SSEConfig     `toml:"sse"`
Observe ObserveConfig `toml:"telemetry"`
Admin   AdminConfig   `toml:"admin"`
```

3. Add an `ApplyEnvOverrides()` method on `*Config` that checks env vars and overlays them on the loaded config. Convention: `FORGE_{SECTION}_{FIELD}`. Key mappings:
   - `FORGE_DATABASE_URL` -> Database.URL
   - `FORGE_SERVER_PORT` -> Server.Port (parse int)
   - `FORGE_SERVER_HOST` -> Server.Host
   - `FORGE_JOBS_ENABLED` -> Jobs.Enabled (parse bool: "true"/"1")
   - `FORGE_SSE_MAX_TOTAL_CONNECTIONS` -> SSE.MaxTotalConnections (parse int)
   - `FORGE_SSE_MAX_PER_USER` -> SSE.MaxPerUser (parse int)
   - `FORGE_OTEL_ENDPOINT` -> Observe.OTLPEndpoint
   - `FORGE_LOG_LEVEL` -> Observe.LogLevel
   - `FORGE_LOG_FORMAT` -> Observe.LogFormat
   - `FORGE_ADMIN_PORT` -> Admin.Port (parse int)
   - `FORGE_ENV` -> if "production", force Observe.LogFormat = "json"
   - `FORGE_SESSION_SECRET` -> Session.Secret

Use `os.Getenv` + `strconv.Atoi` / `strconv.ParseBool` for type conversions. Silently ignore invalid values (log a warning with slog if value cannot be parsed).

4. Update `Default()` to include defaults:
   - SSE: MaxTotalConnections=5000, MaxPerUser=10, BufferSize=32
   - Observe: LogLevel="info", LogFormat="text"
   - Admin: Port=9090
   - Jobs: Enabled=false (explicit opt-in)

5. Update `Load()` to call `cfg.ApplyEnvOverrides()` AFTER toml.Unmarshal, before returning. This ensures env vars always win (DEPLOY-01, 12-factor).
  </action>
  <verify>
Run `go build ./internal/config/...` — compiles.

Verify with a quick check: `go test ./internal/config/... -count=1` if tests exist, or `go vet ./internal/config/...`.
  </verify>
  <done>
Config struct has Jobs, SSE, Observe, and Admin sections. ApplyEnvOverrides reads 12+ env vars with FORGE_ prefix. Load() applies overrides after TOML parse. Defaults set for all new fields.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create observe package with slog, OTel bootstrap, and admin server</name>
  <files>
    internal/observe/slog.go
    internal/observe/otel.go
    internal/observe/admin.go
  </files>
  <action>
1. Create `internal/observe/slog.go`:
   - `func NewHandler(cfg config.ObserveConfig) slog.Handler` — returns `slog.NewJSONHandler(os.Stderr, opts)` when cfg.LogFormat == "json", otherwise `slog.NewTextHandler(os.Stderr, opts)`.
   - `func parseLevel(s string) slog.Level` — maps "debug"->LevelDebug, "info"->LevelInfo, "warn"->LevelWarn, "error"->LevelError, default->LevelInfo.
   - The HandlerOptions sets Level from parseLevel(cfg.LogLevel).
   - Import `log/slog` and `os` from stdlib. Reference config via `github.com/forge-framework/forge/internal/config`.

2. Create `internal/observe/otel.go`:
   - `func Setup(ctx context.Context, cfg config.ObserveConfig, serviceName string) (shutdown func(context.Context) error, err error)` — bootstraps OTel SDK:
     a. Create trace exporter: if `cfg.OTLPEndpoint != ""`, use `otlptracehttp.New(ctx, otlptracehttp.WithEndpoint(cfg.OTLPEndpoint))`; else use `stdouttrace.New(stdouttrace.WithPrettyPrint())` for dev.
     b. Create TracerProvider with batch span processor and resource attributes (service.name = serviceName).
     c. Create Prometheus metrics exporter via `go.opentelemetry.io/otel/exporters/prometheus` New(). Create MeterProvider with this reader.
     d. Set global `otel.SetTracerProvider(tp)` and `otel.SetMeterProvider(mp)`.
     e. Return a shutdown func that calls tp.Shutdown(ctx) and mp.Shutdown(ctx).
   - Required imports: `go.opentelemetry.io/otel`, `go.opentelemetry.io/otel/sdk/trace`, `go.opentelemetry.io/otel/sdk/metric`, `go.opentelemetry.io/otel/exporters/prometheus`, `go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp`, `go.opentelemetry.io/otel/exporters/stdout/stdouttrace`, `go.opentelemetry.io/otel/sdk/resource`, `go.opentelemetry.io/otel/semconv/v1.26.0`.
   - Export `NewHTTPHandler(handler http.Handler, operation string) http.Handler` that wraps with `otelhttp.NewHandler(handler, operation)`. This provides HTTP tracing (OTEL-01).
   - Export `PGXTracer() *otelpgx.Tracer` convenience function returning `otelpgx.NewTracer()` for pgxpool config wiring (OTEL-01 DB traces).

3. Create `internal/observe/admin.go`:
   - `func StartAdminServer(ctx context.Context, cfg config.AdminConfig) *http.Server` — creates a separate http.Server on cfg.Port (default 9090):
     a. `/metrics` — `promhttp.Handler()` from `github.com/prometheus/client_golang/prometheus/promhttp` (OTEL-02)
     b. `/healthz` — JSON response with `{"status":"ok","version":"...","commit":"...","built":"..."}` using cli.Version/Commit/Date from `internal/cli/version.go`
     c. `/debug/pprof/` — register `net/http/pprof` by importing the package blank (`_ "net/http/pprof"`) and using `http.DefaultServeMux` or manually registering pprof handlers on the admin mux.
   - Start the server in a goroutine via `go srv.ListenAndServe()`.
   - Return the *http.Server so the caller can call Shutdown on it.
   - **Important:** Do NOT register pprof on the public mux — only on the admin mux. Use a dedicated ServeMux (not DefaultServeMux). Manually register pprof handlers: `mux.HandleFunc("/debug/pprof/", pprof.Index)`, `mux.HandleFunc("/debug/pprof/cmdline", pprof.Cmdline)`, `mux.HandleFunc("/debug/pprof/profile", pprof.Profile)`, `mux.HandleFunc("/debug/pprof/symbol", pprof.Symbol)`, `mux.HandleFunc("/debug/pprof/trace", pprof.Trace)`.
   - The healthz handler should import `cli.Version`, `cli.Commit`, `cli.Date` for build info (set via ldflags).

Run `go get` to add the new OTel dependencies:
```
go get go.opentelemetry.io/otel
go get go.opentelemetry.io/otel/sdk
go get go.opentelemetry.io/contrib/instrumentation/net/http/otelhttp
go get github.com/exaring/otelpgx
go get github.com/prometheus/client_golang/prometheus/promhttp
go get go.opentelemetry.io/otel/exporters/prometheus
go get go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp
go get go.opentelemetry.io/otel/exporters/stdout/stdouttrace
```
  </action>
  <verify>
Run `go build ./internal/observe/...` — compiles.

Run `go build ./internal/config/...` — compiles.

Run `go vet ./internal/observe/...` — no issues.
  </verify>
  <done>
slog handler factory selects JSON/text based on config. OTel Setup() bootstraps TracerProvider + MeterProvider with Prometheus exporter. Admin server serves /metrics, /healthz, /debug/pprof/ on separate port. NewHTTPHandler and PGXTracer convenience functions exported for HTTP and DB tracing.
  </done>
</task>

</tasks>

<verification>
1. `go build ./internal/config/...` and `go build ./internal/observe/...` — both compile
2. `go vet ./...` — no issues
3. Config env override: setting FORGE_DATABASE_URL should override toml value (verify by reading code logic)
4. Admin server setup is callable and returns *http.Server
</verification>

<success_criteria>
- Config has 4 new sections (Jobs, SSE, Observe, Admin) with TOML tags
- ApplyEnvOverrides handles 12+ env vars with FORGE_ prefix
- Load() calls ApplyEnvOverrides after TOML parse
- slog handler switches JSON/text based on config
- OTel TracerProvider + MeterProvider bootstrapped
- Prometheus metrics exposed on admin server /metrics
- /healthz returns version info JSON
- /debug/pprof/ accessible on admin port only
</success_criteria>

<output>
After completion, create `.planning/phases/08-background-jobs-production-readiness/08-02-SUMMARY.md`
</output>
