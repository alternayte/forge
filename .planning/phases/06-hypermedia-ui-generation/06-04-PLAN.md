---
phase: 06-hypermedia-ui-generation
plan: 04
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - internal/generator/templates/scaffold_handlers.go.tmpl
  - internal/generator/templates/scaffold_hooks.go.tmpl
  - internal/generator/templates/html_register_all.go.tmpl
autonomous: true

must_haves:
  truths:
    - "Scaffold handler template produces HTTP handlers that call the action layer (not DB directly)"
    - "Scaffold handler template reads Datastar signals and sends SSE responses"
    - "Scaffold hooks template provides lifecycle hook stubs for developer customization"
    - "Generated html_register_all.go dispatches HTML route registration across all resources"
  artifacts:
    - path: "internal/generator/templates/scaffold_handlers.go.tmpl"
      provides: "HTML handler scaffold template"
      contains: "HandleCreate"
    - path: "internal/generator/templates/scaffold_hooks.go.tmpl"
      provides: "Lifecycle hooks scaffold template"
      contains: "hooks"
    - path: "internal/generator/templates/html_register_all.go.tmpl"
      provides: "HTML route dispatcher template"
      contains: "RegisterAllHTMLRoutes"
  key_links:
    - from: "scaffold_handlers.go.tmpl"
      to: "actions"
      via: "action layer calls"
      pattern: "acts\\.Create|acts\\.List|acts\\.Get|acts\\.Update|acts\\.Delete"
    - from: "scaffold_handlers.go.tmpl"
      to: "datastar"
      via: "SSE response"
      pattern: "datastar\\.NewSSE|datastar\\.ReadSignals"
---

<objective>
Create HTML handler scaffold templates and HTML route registration template

Purpose: Define the Go text/template files that will render into resources/<name>/handlers.go and resources/<name>/hooks.go (scaffold-once), plus a generated-always html_register_all.go that dispatches all HTML routes. Handlers call the action layer and respond via Datastar SSE.

Output: Two scaffold templates and one generation template
</objective>

<execution_context>
@/Users/nathananderson-tennant/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nathananderson-tennant/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@internal/generator/funcmap.go
@internal/generator/templates/api_register_all.go.tmpl
@internal/parser/ir.go
@.planning/phases/06-hypermedia-ui-generation/06-RESEARCH.md
@.planning/phases/06-hypermedia-ui-generation/06-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create scaffold handlers and hooks templates</name>
  <files>
    internal/generator/templates/scaffold_handlers.go.tmpl
    internal/generator/templates/scaffold_hooks.go.tmpl
  </files>
  <action>
    Create scaffold_handlers.go.tmpl that renders resources/<name>/handlers.go.

    The template receives {Resource: parser.ResourceIR, ProjectModule: string}.

    Generated handlers.go must contain:

    1. Package: `package {{lower .Resource.Name}}` (package per resource directory)

    2. Imports: net/http, models from gen/models, actions from gen/actions, views subpackage, datastar-go/datastar, gen/html/sse as ssehelpers

    3. Register{{.Resource.Name}}HTMLRoutes(router chi.Router, acts actions.{{.Resource.Name}}Actions):
       - Groups routes under /{{kebab (plural .Resource.Name)}}
       - GET / -> HandleList (render list page)
       - GET /new -> HandleNew (render empty form)
       - GET /{id} -> HandleDetail (render detail page)
       - GET /{id}/edit -> HandleEdit (render form with existing data)
       - POST / -> HandleCreate (Datastar SSE handler)
       - PUT /{id} -> HandleUpdate (Datastar SSE handler)
       - DELETE /{id} -> HandleDelete (Datastar SSE handler)

    4. HandleList(acts) http.HandlerFunc:
       - Parses sort/filter/page query params
       - Calls acts.List(ctx, filter, sort, page, pageSize)
       - Renders views.{{.Resource.Name}}List(...) via templ.Handler

    5. HandleNew() http.HandlerFunc:
       - Renders views.{{.Resource.Name}}Form(nil, nil, "") with empty model and no errors

    6. HandleDetail(acts) http.HandlerFunc:
       - Parses {id} from chi.URLParam
       - Calls acts.Get(ctx, id)
       - Renders views.{{.Resource.Name}}Detail(item)

    7. HandleEdit(acts) http.HandlerFunc:
       - Parses {id}, calls acts.Get(ctx, id)
       - Renders views.{{.Resource.Name}}Form(item, nil, "")

    8. HandleCreate(acts) http.HandlerFunc:
       - Reads Datastar signals via datastar.ReadSignals(r, &signals)
       - Builds models.{{.Resource.Name}}Create from signals
       - Calls acts.Create(ctx, createInput)
       - On error: extracts field errors, re-renders form via sse.PatchElementTempl
       - On success: calls sse.Redirect to detail page

    9. HandleUpdate(acts) http.HandlerFunc:
       - Parses {id}, reads signals
       - Builds models.{{.Resource.Name}}Update from signals
       - Calls acts.Update(ctx, id, updateInput)
       - On error: re-renders form with errors
       - On success: redirects to detail page

    10. HandleDelete(acts) http.HandlerFunc:
        - Parses {id}
        - Calls acts.Delete(ctx, id)
        - Redirects to list page via SSE

    11. Helper: toFieldErrors(err error) map[string]string:
        - Type-asserts err to forge error with field errors
        - Converts to map[string]string for template rendering

    12. Helper: parseUUID(s string) (uuid.UUID, error):
        - Parses Chi URL param to uuid.UUID

    Create scaffold_hooks.go.tmpl that renders resources/<name>/hooks.go:

    1. Package: `package {{lower .Resource.Name}}`
    2. Comment explaining lifecycle hooks purpose
    3. Stub functions: BeforeCreate, AfterCreate, BeforeUpdate, AfterUpdate, BeforeDelete, AfterDelete
    4. Each hook takes context and the relevant model type, returns error
    5. Default implementations return nil (no-op)
    6. Comments explaining how developers can add custom logic
  </action>
  <verify>
    go build ./internal/generator/
  </verify>
  <done>
    scaffold_handlers.go.tmpl generates HTTP handlers with 7 routes that call action layer for business logic and respond via Datastar SSE. scaffold_hooks.go.tmpl generates lifecycle hook stubs for developer customization.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create HTML route registration template</name>
  <files>
    internal/generator/templates/html_register_all.go.tmpl
  </files>
  <action>
    Create html_register_all.go.tmpl following the pattern of api_register_all.go.tmpl.

    This template generates gen/html/register_all.go — a generated-always file (not scaffold-once).

    The template receives {Resources: []parser.ResourceIR, ProjectModule: string}.

    Generated register_all.go must contain:

    1. Package: `package html`

    2. Imports: chi, actions from gen/actions, each resource package from resources/<name>

    3. RegisterAllHTMLRoutes(router chi.Router, registry *actions.Registry):
       - For each resource:
         - Type-asserts registry.Get("{{lower .Name}}") to actions.{{.Name}}Actions
         - Calls {{lower .Name}}.Register{{.Name}}HTMLRoutes(router, typedActions)
       - Same pattern as api_register_all.go.tmpl but for HTML routes

    This is the HTML counterpart to gen/api/register_all.go. It wires all resource-specific HTML route registrations through the shared action registry.

    The import paths for resource packages use the project module: {{.ProjectModule}}/resources/{{snake .Name}}
  </action>
  <verify>
    go build ./internal/generator/
  </verify>
  <done>
    html_register_all.go.tmpl generates RegisterAllHTMLRoutes dispatcher that type-asserts actions from registry and calls per-resource route registration functions. Follows same pattern as api_register_all.go.tmpl.
  </done>
</task>

</tasks>

<verification>
- go build ./internal/generator/ compiles cleanly (templates parse correctly)
- scaffold_handlers.go.tmpl contains: Register...HTMLRoutes, HandleList, HandleNew, HandleDetail, HandleEdit, HandleCreate, HandleUpdate, HandleDelete
- scaffold_handlers.go.tmpl calls action layer (acts.Create, acts.List, etc.) — not DB directly
- scaffold_handlers.go.tmpl uses datastar.ReadSignals and datastar.NewSSE for SSE interaction
- scaffold_hooks.go.tmpl contains: BeforeCreate, AfterCreate, BeforeUpdate, AfterUpdate, BeforeDelete, AfterDelete stubs
- html_register_all.go.tmpl contains: RegisterAllHTMLRoutes, registry.Get, type assertion pattern
</verification>

<success_criteria>
- GEN-10 satisfied: HTML handlers scaffolded calling action layer
- Handlers read Datastar signals and send SSE responses (HTML-01/HTML-06 wiring)
- Hooks template provides extensibility points for developer customization
- HTML route registration dispatcher ready for server wiring
</success_criteria>

<output>
After completion, create `.planning/phases/06-hypermedia-ui-generation/06-04-SUMMARY.md`
</output>
