---
phase: 06-hypermedia-ui-generation
plan: 09
type: execute
wave: 4
depends_on: ["06-05", "06-06", "06-08"]
files_modified:
  - internal/cli/generate_resource.go
  - internal/cli/root.go
  - internal/api/html_server.go
  - internal/watcher/tailwind.go
autonomous: true

must_haves:
  truths:
    - "forge generate resource <name> scaffolds views and handlers into resources/<name>/"
    - "forge generate resource <name> --diff shows differences without writing files"
    - "SetupHTML function wires session middleware and HTML routes on Chi router"
    - "Tailwind CSS compiles via standalone CLI binary (zero npm dependency)"
  artifacts:
    - path: "internal/cli/generate_resource.go"
      provides: "forge generate resource CLI command"
      contains: "resource"
    - path: "internal/api/html_server.go"
      provides: "HTML server setup with session middleware"
      contains: "SetupHTML"
    - path: "internal/watcher/tailwind.go"
      provides: "Tailwind CSS compilation helper"
      contains: "RunTailwind"
  key_links:
    - from: "internal/cli/generate_resource.go"
      to: "internal/generator/scaffold.go"
      via: "ScaffoldResource call"
      pattern: "generator\\.ScaffoldResource"
    - from: "internal/api/html_server.go"
      to: "internal/auth/session.go"
      via: "session middleware"
      pattern: "SessionMiddleware|LoadAndSave"
    - from: "internal/watcher/tailwind.go"
      to: "internal/toolsync"
      via: "Tailwind binary path"
      pattern: "tailwindcss"
---

<objective>
Create forge generate resource CLI command, HTML server wiring, and Tailwind compilation

Purpose: Wire everything together: (1) the forge generate resource <name> [--diff] CLI command that invokes ScaffoldResource, (2) the SetupHTML server function that wires session middleware and HTML route registration, and (3) Tailwind CSS compilation via the standalone CLI binary.

Output: CLI command, HTML server setup, Tailwind compilation helper
</objective>

<execution_context>
@/Users/nathananderson-tennant/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nathananderson-tennant/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@internal/cli/generate.go
@internal/cli/root.go
@internal/api/server.go
@internal/watcher/
@internal/toolsync/registry.go
@.planning/phases/06-hypermedia-ui-generation/06-RESEARCH.md
@.planning/phases/06-hypermedia-ui-generation/06-06-SUMMARY.md
@.planning/phases/06-hypermedia-ui-generation/06-08-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create forge generate resource CLI command with --diff flag</name>
  <files>
    internal/cli/generate_resource.go
    internal/cli/root.go
  </files>
  <action>
    Create generate_resource.go in internal/cli/ with:

    1. newGenerateResourceCmd() *cobra.Command:
       - Use: "resource <name>"
       - Short: "Scaffold HTML form, list, and detail views for a resource"
       - Args: cobra.ExactArgs(1)
       - RunE: runGenerateResource
       - Flag: --diff bool "Show diff between current and freshly scaffolded views"

    2. runGenerateResource(cmd *cobra.Command, args []string) error:
       - Gets resource name from args[0]
       - Finds project root via findProjectRoot()
       - Loads config via config.Load
       - Parses schemas via parser.ParseDir(resourcesDir)
       - Finds the matching resource by name (case-insensitive)
       - If not found, returns error listing available resources

       If --diff flag:
       - Calls generator.DiffResource(resource, projectRoot, cfg.Project.Module)
       - Prints diff output to stdout
       - Returns

       If not --diff:
       - Calls generator.ScaffoldResource(resource, projectRoot, cfg.Project.Module)
       - Prints created/skipped files using ui.Success and ui.Info
       - After scaffolding, runs templ generate on the resource views directory:
         - Find templ binary via toolsync or PATH
         - Run: templ generate ./resources/<name>/views/
         - This compiles .templ files to _templ.go (Pitfall 1 from research)
       - Print summary: "Scaffolded N files for <Name> (M skipped)"

    Update root.go:
    - Add generateResourceCmd as a subcommand of the existing generateCmd:
      ```go
      generateCmd.AddCommand(newGenerateResourceCmd())
      ```
    - This makes it: `forge generate resource <name>` (subcommand of generate)
  </action>
  <verify>
    go build ./
    go vet ./internal/cli/
  </verify>
  <done>
    forge generate resource <name> scaffolds views and handlers. forge generate resource <name> --diff shows unified diff without writing. Command registered as subcommand of forge generate. Templ generate runs on scaffolded .templ files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create HTML server setup and Tailwind compilation helper</name>
  <files>
    internal/api/html_server.go
    internal/watcher/tailwind.go
  </files>
  <action>
    Create html_server.go in internal/api/ with:

    1. HTMLServerConfig struct:
       - SessionManager *scs.SessionManager
       - RegisterRoutes func(chi.Router) (HTML route registration function)

    2. SetupHTML(router chi.Router, cfg HTMLServerConfig) error:
       - Adds session middleware: router.Use(cfg.SessionManager.LoadAndSave)
       - Note: OAuth callback routes must be registered BEFORE RequireSession group (Pitfall 4)

       - Creates a public route group (no auth required):
         ```go
         router.Group(func(r chi.Router) {
             // Public auth routes go here
             // RegisterOAuthRoutes and login/logout handlers
         })
         ```

       - Creates a protected route group:
         ```go
         router.Group(func(r chi.Router) {
             r.Use(auth.RequireSession(cfg.SessionManager))
             // Resource HTML routes go here
             if cfg.RegisterRoutes != nil {
                 cfg.RegisterRoutes(r)
             }
         })
         ```

       - Returns nil (errors handled internally via middleware)
       - Comment: "Session LoadAndSave must wrap ALL routes including auth routes so OAuth callback can commit sessions (Pitfall 9)"

    Create tailwind.go in internal/watcher/ with:

    1. RunTailwind(projectRoot string) error:
       - Constructs Tailwind binary path: filepath.Join(projectRoot, ".forge", "bin", "tailwindcss")
       - Checks binary exists. If not, returns clear error: "Tailwind CSS binary not found. Run 'forge tool sync' first."
       - Constructs input path: filepath.Join(projectRoot, "resources", "css", "input.css")
       - Constructs output path: filepath.Join(projectRoot, "public", "css", "output.css")
       - Ensures public/css/ directory exists
       - Runs: exec.Command(binPath, "-i", inputPath, "-o", outputPath)
       - Sets cmd.Dir = projectRoot
       - Returns cmd.Run() error

    2. RunTailwindWatch(projectRoot string) (*exec.Cmd, error):
       - Same as RunTailwind but adds "--watch" flag
       - Starts the command (cmd.Start, not cmd.Run)
       - Returns the Cmd so the caller can stop it
       - Used by forge dev for continuous compilation

    3. ScaffoldTailwindInput(projectRoot string) error:
       - Creates resources/css/input.css if it doesn't exist
       - Uses Tailwind v3 syntax (matching current registry v3.4.17):
         ```css
         @tailwind base;
         @tailwind components;
         @tailwind utilities;
         ```
       - Also creates a tailwind.config.js with content paths scanning .templ files:
         ```js
         module.exports = {
           content: ["./resources/**/*.templ", "./gen/**/*.templ"],
           theme: { extend: {} },
           plugins: [],
         }
         ```
       - Skip if files already exist (scaffold-once pattern)
       - Note: Tailwind v3.4.17 needs this config. Tailwind v4 uses different syntax (CSS-first). We stay with v3 per current registry.
  </action>
  <verify>
    go build ./internal/api/
    go build ./internal/watcher/
    go vet ./internal/...
  </verify>
  <done>
    SetupHTML wires session middleware with public (auth) and protected (resource) route groups. RunTailwind compiles CSS via standalone CLI binary. RunTailwindWatch provides --watch mode for forge dev. ScaffoldTailwindInput creates input.css and tailwind.config.js.
  </done>
</task>

</tasks>

<verification>
- go build ./ compiles cleanly (full binary)
- go vet ./internal/... reports no issues
- forge generate resource --help shows command with --diff flag
- html_server.go groups routes: public (auth) vs protected (resources)
- html_server.go adds session LoadAndSave BEFORE auth middleware
- tailwind.go RunTailwind uses .forge/bin/tailwindcss binary (zero npm)
- tailwind.go ScaffoldTailwindInput creates input.css with content paths for .templ files
- All existing tests pass (no regressions)
</verification>

<success_criteria>
- GEN-09 complete: forge generate resource <name> scaffolds Templ components
- GEN-10 complete: forge generate resource <name> scaffolds HTML handlers
- GEN-12 complete: forge generate resource <name> --diff shows differences
- AUTH-01/02/03 wiring: SetupHTML provides session + auth route groups
- DEPLOY-05 satisfied: Tailwind CSS compiles via standalone CLI binary (zero npm)
- Phase 6 success criteria fully met
</success_criteria>

<output>
After completion, create `.planning/phases/06-hypermedia-ui-generation/06-09-SUMMARY.md`
</output>
