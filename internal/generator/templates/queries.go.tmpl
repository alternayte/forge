// Code generated by forge generate. DO NOT EDIT.

package queries

import (
	"{{.ProjectModule}}/gen/models"
	{{- if .Options.TenantScoped}}
	"context"
	forgeauth "github.com/alternayte/forge/internal/auth"
	{{- end}}
	"github.com/stephenafamo/bob/dialect/psql"
	"github.com/stephenafamo/bob/dialect/psql/sm"
)

{{- $resource := .Name}}

// {{$resource}}Filters provides type-safe filter methods for {{$resource}} queries.
type {{$resource}}Filters struct{}

{{- range .Fields}}
{{- if isFilterable .Modifiers}}

// {{.Name}}EQ returns a query mod for filtering by {{.Name}} equals.
func (f {{$resource}}Filters) {{.Name}}EQ(val {{goType .Type}}) sm.QueryMod[*psql.SelectQuery] {
	return sm.Where(psql.Quote("{{snake .Name}}").EQ(psql.Arg(val)))
}

// {{.Name}}NEQ returns a query mod for filtering by {{.Name}} not equals.
func (f {{$resource}}Filters) {{.Name}}NEQ(val {{goType .Type}}) sm.QueryMod[*psql.SelectQuery] {
	return sm.Where(psql.Quote("{{snake .Name}}").NE(psql.Arg(val)))
}

{{- if or (eq .Type "Int") (eq .Type "BigInt") (eq .Type "Decimal") (eq .Type "DateTime") (eq .Type "Date")}}

// {{.Name}}GTE returns a query mod for filtering by {{.Name}} greater than or equal.
func (f {{$resource}}Filters) {{.Name}}GTE(val {{goType .Type}}) sm.QueryMod[*psql.SelectQuery] {
	return sm.Where(psql.Quote("{{snake .Name}}").GTE(psql.Arg(val)))
}

// {{.Name}}LTE returns a query mod for filtering by {{.Name}} less than or equal.
func (f {{$resource}}Filters) {{.Name}}LTE(val {{goType .Type}}) sm.QueryMod[*psql.SelectQuery] {
	return sm.Where(psql.Quote("{{snake .Name}}").LTE(psql.Arg(val)))
}
{{- end}}

{{- if or (eq .Type "String") (eq .Type "Text") (eq .Type "Email") (eq .Type "URL") (eq .Type "Slug")}}

// {{.Name}}Contains returns a query mod for filtering by {{.Name}} contains (case-insensitive).
func (f {{$resource}}Filters) {{.Name}}Contains(val string) sm.QueryMod[*psql.SelectQuery] {
	return sm.Where(psql.Quote("{{snake .Name}}").ILike(psql.Arg("%" + val + "%")))
}
{{- end}}
{{- end}}
{{- end}}

// FilterMods converts a {{$resource}}Filter to a slice of Bob query mods.
func FilterMods(filter models.{{$resource}}Filter) []sm.QueryMod[*psql.SelectQuery] {
	var mods []sm.QueryMod[*psql.SelectQuery]
	filters := {{$resource}}Filters{}

	{{- range .Fields}}
	{{- if isFilterable .Modifiers}}
	if filter.{{.Name}} != nil {
		mods = append(mods, filters.{{.Name}}EQ(*filter.{{.Name}}))
	}
	if filter.{{.Name}}Neq != nil {
		mods = append(mods, filters.{{.Name}}NEQ(*filter.{{.Name}}Neq))
	}
	{{- end}}
	{{- end}}

	return mods
}

// SortMod converts a {{$resource}}Sort to a Bob query mod.
func SortMod(sort models.{{$resource}}Sort) sm.QueryMod[*psql.SelectQuery] {
	var columnName string

	// Map field name to column name
	switch sort.Field {
	{{- range .Fields}}
	{{- if isSortable .Modifiers}}
	case "{{.Name}}", "{{snake .Name}}":
		columnName = "{{snake .Name}}"
	{{- end}}
	{{- end}}
	default:
		// Invalid field, return no-op mod
		return sm.QueryMod[*psql.SelectQuery]{}
	}

	// Build order by mod
	orderBy := sm.OrderBy(psql.Quote(columnName))
	if sort.Direction == "desc" {
		return orderBy.Desc()
	}
	return orderBy.Asc()
}
{{- if .Options.SoftDelete}}

// ActiveMod returns a query mod that excludes soft-deleted records.
// Applied by default to List and Get queries.
func (f {{$resource}}Filters) ActiveMod() sm.QueryMod[*psql.SelectQuery] {
	return sm.Where(psql.Quote("deleted_at").IsNull())
}

// OnlyTrashedMod returns a query mod that shows only soft-deleted records.
func (f {{$resource}}Filters) OnlyTrashedMod() sm.QueryMod[*psql.SelectQuery] {
	return sm.Where(psql.Quote("deleted_at").IsNotNull())
}
{{- end}}
{{- if .Options.TenantScoped}}

// TenantMod scopes the query to the current tenant from context.
// Panics if tenant ID is not in context — ensure TenantMiddleware is applied.
func (f {{$resource}}Filters) TenantMod(ctx context.Context) sm.QueryMod[*psql.SelectQuery] {
	tenantID, ok := forgeauth.TenantFromContext(ctx)
	if !ok {
		panic("{{$resource}}: tenant ID required in context — is TenantMiddleware applied?")
	}
	return sm.Where(psql.Quote("tenant_id").EQ(psql.Arg(tenantID)))
}
{{- end}}
